# CMITS - Configuration Management for Information Technology Systems
# Based on <https://github.com/afseo/cmits>.
# Copyright 2015 Jared Jennings <mailto:jjennings@fastmail.fm>.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
require 'find'
#
# See
# https://afseo.eglin.af.mil/projects/admin/browser/branches/production/cf/modules/module:nvidia
# for how to also detect legacy nVidia cards.
#

def nvidia_graphics_card_device_dirs
    nvidia_pci_vendor_id = '0x10de'
    video_card_class = '0x030000'
    pci_devices = '/sys/bus/pci/devices'
    Dir.glob(File.join(pci_devices,'*')).select do |device_dir|
        vendor = File.read(File.join(device_dir, 'vendor')).strip
        class_ = File.read(File.join(device_dir, 'class')).strip
        vendor == nvidia_pci_vendor_id and class_ == video_card_class
    end
end

Facter.add("has_nvidia_graphics_card") do
    confine :kernel => "Linux"
    setcode do
        nvidia_graphics_card_device_dirs.any?
    end
end

Facter.add("has_nvidia_legacy_340_graphics_card") do
    confine :kernel => "Linux"
    setcode do
        # list is at http://www.nvidia.com/object/IO_32667.html
        legacy_340_product_ids = %w{0x0191 0x0193 0x0194 0x0197 0x019D 0x019E 0x0400 0x0401 0x0402 0x0403 0x0404 0x0405 0x0406 0x0407 0x0408 0x0409 0x040A 0x040B 0x040C 0x040D 0x040E 0x040F 0x0410 0x0420 0x0421 0x0422 0x0423 0x0424 0x0425 0x0426 0x0427 0x0428 0x0429 0x042A 0x042B 0x042C 0x042D 0x042E 0x042F 0x05E0 0x05E1 0x05E2 0x05E3 0x05E6 0x05E7 0x0595 0x068F 0x0697 0x0714 0x0743 0x05EA 0x05EB 0x05ED 0x05F8 0x05F9 0x05FD 0x05FE 0x05FF 0x0600 0x0601 0x0602 0x0603 0x0604 0x0605 0x0606 0x0607 0x0608 0x0609 0x00A7 0x060A 0x060B 0x060C 0x060D 0x060F 0x0610 0x0611 0x0612 0x0613 0x0614 0x0615 0x0617 0x0618 0x0619 0x061A 0x061B 0x061C 0x061D 0x061E 0x061F 0x0621 0x0622 0x0623 0x0625 0x0626 0x0627 0x0628 0x062A 0x062B 0x062C 0x062D 0x062E 0x0605 0x0630 0x0631 0x0632 0x0635 0x0637 0x0638 0x063A 0x0640 0x0641 0x0643 0x0644 0x0645 0x0646 0x0647 0x0648 0x0649 0x202D 0x064A 0x064B 0x064C 0x0651 0x0652 0x0850 0x0653 0x0654 0x14A2 0x14D2 0x0633 0x0693 0x0658 0x0659 0x065A 0x065B 0x065C 0x06E0 0x06E1 0x06E2 0x06E3 0x06E4 0x06E5 0x06E6 0x06E7 0x06E8 0x360B 0x06E9 0x06EA 0x06EB 0x06EC 0x06EF 0x06F1 0x06F8 0x06F9 0x060D 0x06FA 0x06FB 0x06FD 0x06FF 0x0711 0x0840 0x0844 0x0845 0x0846 0x0847 0x0848 0x0849 0x084A 0x084B 0x084C 0x084D 0x084F 0x0860 0x0861 0x0862 0x0863 0x0864 0x0865 0x0866 0x00B1 0x0867 0x0868 0x0869 0x086A 0x086C 0x086D 0x086E 0x086F 0x0870 0x0871 0x0872 0x1C42 0x0873 0x1C52 0x0874 0x0876 0x087A 0x087D 0x087E 0x087F 0x08A0 0x08A2 0x08A3 0x08A4 0x08A5 0x0A20 0x0A22 0x0A23 0x0A26 0x0A27 0x0A28 0x0A29 0x0A2A 0x0A2B 0x0A2C 0x0A2D 0x0A32 0x0A34 0x0A35 0x0A38 0x0A3C 0x0A60 0x0A62 0x0A63 0x0A64 0x0A65 0x0A66 0x0A67 0x0A68 0x0A69 0x0A6A 0x0A6C 0x0A6E 0x3607 0x0A6F 0x0A70 0x3605 0x3617 0x0A71 0x0A72 0x0A73 0x3607 0x3610 0x0A74 0x903A 0x0A75 0x3605 0x0A76 0x0A78 0x0A7A 0x0003 0x3950 0x397D 0x3980 0x8006 0x90B4 0xAA51 0xAA58 0xAC71 0xAC82 0x0A7C 0x0CA0 0x0CA2 0x0CA3 0x0CA4 0x0CA5 0x0CA7 0x0CA8 0x0CA9 0x0CAC 0x0CAF 0x0CB0 0x0CB1 0x0CBC 0x10C0 0x10C3 0x10C5 0x10D8}
        installed_product_ids = nvidia_graphics_card_device_dirs.collect {|d|
            File.read(File.join(d, 'device')).strip
        }
        installed_product_ids.any? {|id| legacy_340_product_ids.member? id }
    end
end

Facter.add("has_nvidia_legacy_304_graphics_card") do
    confine :kernel => "Linux"
    setcode do
        # list is at http://www.nvidia.com/object/IO_32667.html
        legacy_304_product_ids = %w{0x0040 0x0041 0x0042 0x0043 0x0044 0x0045 0x0046 0x0047 0x0048 0x004e 0x0090 0x0091 0x0092 0x0093 0x0095 0x0098 0x0099 0x009d 0x00c0 0x00c1 0x00c2 0x00c3 0x00c8 0x00c9 0x00cc 0x00cd 0x00ce 0x00f1 0x00f2 0x00f3 0x00f4 0x00f5 0x00f6 0x00f8 0x00f9 0x0140 0x0141 0x0142 0x0143 0x0144 0x0145 0x0146 0x0147 0x0148 0x0149 0x014a 0x014c 0x014d 0x014e 0x014f 0x0160 0x0161 0x0162 0x0163 0x0164 0x0165 0x0166 0x0167 0x0168 0x0169 0x016a 0x01d0 0x01d1 0x01d2 0x01d3 0x01d6 0x01d7 0x01d8 0x01da 0x01db 0x01dc 0x01dd 0x01de 0x01df 0x0211 0x0212 0x0215 0x0218 0x0221 0x0222 0x0240 0x0241 0x0242 0x0244 0x0245 0x0247 0x0290 0x0291 0x0292 0x0293 0x0294 0x0295 0x0297 0x0298 0x0299 0x029a 0x029b 0x029c 0x029d 0x029e 0x029f 0x02e0 0x02e1 0x02e2 0x02e3 0x02e4 0x038b 0x0390 0x0391 0x0392 0x0393 0x0394 0x0395 0x0397 0x0398 0x0399 0x039c 0x039e 0x03d0 0x03d1 0x03d2 0x03d5 0x03d6 0x0531 0x0533 0x053a 0x053b 0x053e 0x07e0 0x07e1 0x07e2 0x07e3 0x07e5}
        installed_product_ids = nvidia_graphics_card_device_dirs.collect {|d|
            File.read(File.join(d, 'device')).strip
        }
        installed_product_ids.any? {|id| legacy_304_product_ids.member? id }
    end
end

Facter.add("has_nvidia_legacy_17314_graphics_card") do
    confine :kernel => "Linux"
    setcode do
        # list is at http://www.nvidia.com/object/IO_32667.html
        legacy_17314_product_ids = %w{0x00fa 0x00fb 0x00fc 0x00fd 0x00fe 0x0301 0x0302 0x0308 0x0309 0x0311 0x0312 0x0314 0x031a 0x031b 0x031c 0x0320 0x0321 0x0322 0x0323 0x0324 0x0325 0x0326 0x0327 0x0328 0x032a 0x032b 0x032c 0x032d 0x0330 0x0331 0x0332 0x0333 0x0334 0x0338 0x033f 0x0341 0x0342 0x0343 0x0344 0x0347 0x0348 0x034c 0x034e}
        installed_product_ids = nvidia_graphics_card_device_dirs.collect {|d|
            File.read(File.join(d, 'device')).strip
        }
        installed_product_ids.any? {|id| legacy_17314_product_ids.member? id }
    end
end


Facter.add("using_nouveau_driver") do
    confine :kernel => "Linux"
    setcode do
        drivers = nvidia_graphics_card_device_dirs.collect {|d|
            driver = File.join(d, 'driver')
            if File.exists?(driver)
                File.readlink(driver)
            else
                ''
            end
        }
        drivers.any? {|x| x.end_with? "/nouveau" }
    end
end

Facter.add("nvidia_ko_exists") do
    confine :kernel => "Linux"
    setcode do
        kernel_version = %x{uname -r}.strip
        ko = File.join('/lib', 'modules', kernel_version,
                       'kernel', 'drivers', 'video', 'nvidia.ko')
        File.exists?(ko)
    end
end

Facter.add("nvidia_libGL_installed") do
    confine :kernel => "Linux"
    setcode do
        oldcwd = Dir.pwd
        Dir.chdir('/usr/lib64')
        filename = 'libGL.so'
        seen = ['libGL.so']
        # Follow symlinks until we reach a loop, a non-symlink
        # (EINVAL), or a broken link (ENOENT); final destination will
        # be in filename.
        while true
          begin
            filename = File.readlink(filename)
            break if seen.include? filename
            seen << filename
          rescue Errno::EINVAL, Errno::ENOENT
            break
          end
        end
        Dir.chdir(oldcwd)
        # filename should now be something like 'libGL.so.319.23'
        # the oldest legacy driver we may have is 173.x
        if filename =~ /libGL\.so\.([0-9]+)(\.[0-9]+)*/
          major = $1
          major.to_i >= 150
        else
          # what is this thing pointing to? doesn't look right, better
          # reinstall the driver.
          false
        end
    end
end

Facter.add("nvidia_glx_extension_installed") do
    confine :kernel => "Linux"
    setcode do
        oldcwd = Dir.pwd
        Dir.chdir('/usr/lib64/xorg/modules/extensions')
        filename = 'libglx.so'
        seen = ['libglx.so']
        # Follow symlinks until we reach a loop, a non-symlink
        # (EINVAL), or a broken link (ENOENT); final destination will
        # be in filename.
        while true
          begin
            filename = File.readlink(filename)
            break if seen.include? filename
            seen << filename
          rescue Errno::EINVAL, Errno::ENOENT
            break
          end
        end
        Dir.chdir(oldcwd)
        # filename should now be something like 'libglx.so.331.67'. If
        # it is not, perhaps libglx.so 
        if filename =~ /libglx\.so\.([0-9]+)(\.[0-9]+)*/
          major = $1
          major.to_i >= 150
        else
          # it didn't have those numbers at the end. perhaps it was
          # not a symlink, and perhaps this is because an X server
          # upgrade overwrote it. in any case this is not the nvidia
          # glx extension.
          false
        end
    end
end
